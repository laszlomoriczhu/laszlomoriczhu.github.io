<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medication Supply Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007BFF;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --success-color: #28a745;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 20px;
            color: #343a40;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 40px;
            font-weight: 700;
        }

        /* Sort Control Styling */
        .sort-control {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
        }

        .sort-control label {
            font-weight: 700;
            margin-right: 10px;
            color: #495057;
        }

        .sort-control select {
            padding: 8px 15px;
            border-radius: var(--border-radius);
            border: 1px solid #ced4da;
            background-color: #fff;
            font-size: 1rem;
            cursor: pointer;
            transition: border-color 0.3s;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007BFF%22%20d%3D%22M287%2073.5c-4.1-4.1-9.3-6.2-14.7-6.2s-10.5%202.1-14.7%206.2L146.2%20199.1%2034.7%2073.5c-4.1-4.1-9.3-6.2-14.7-6.2S10%2069.4%205.8%2073.5c-8.2%208.2-8.2%2021.5%200%2029.7l130%20130c4.1%204.1%209.3%206.2%2014.7%206.2s10.5-2.1%2014.7-6.2l130-130c8.3-8.2%208.3-21.5.1-29.7z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 10px auto;
        }

        .sort-control select:focus {
            border-color: var(--primary-color);
            outline: none;
        }


        .medication-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .medication-card {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            border-left: 5px solid var(--primary-color);
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            flex-direction: column;
        }

        .medication-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .medication-card h2 {
            margin-top: 0;
            color: #495057;
            font-size: 1.5rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-weight: 400;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .label {
            font-weight: 700;
            color: var(--secondary-color);
        }

        .value {
            font-weight: 400;
        }

        .equivalence-info {
            font-size: 0.85rem;
            font-weight: 500;
            color: #28a745; /* Green for equivalent */
            margin-bottom: 15px;
            padding: 5px 0;
            border-top: 1px dotted #e0e0e0;
            text-align: center;
        }
        
        .equivalence-info strong {
            font-weight: 700;
        }


        .expiration-info {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #ced4da;
            text-align: center;
            flex-grow: 1; 
        }

        .expiration-date {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .days-remaining {
            font-size: 2.2rem;
            font-weight: 700;
        }

        /* Color Coding for Days Remaining */
        .status-danger {
            color: var(--danger-color); 
        }
        .status-warning {
            color: var(--warning-color); 
        }
        .status-safe {
            color: var(--success-color); 
        }
        
        /* Details Button Style */
        .details-button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            margin-top: 20px;
            background-color: var(--secondary-color);
            color: white;
            text-align: center;
            text-decoration: none;
            border-radius: var(--border-radius);
            font-weight: 700;
            transition: background-color 0.3s;
            border: none;
            cursor: pointer;
        }

        .details-button:hover {
            background-color: #5a6268;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ’Š Your Medication Supply Tracker</h1>

        <div class="sort-control">
            <label for="sortSelector">Sort By:</label>
            <select id="sortSelector" onchange="renderMedications()">
                <option value="days_asc">Days Remaining (Ascending)</option>
                <option value="days_desc">Days Remaining (Descending)</option>
                <option value="name_asc">Name (A-Z)</option>
            </select>
        </div>

        <div class="medication-list" id="medicationList">
            </div>
    </div>

    <script>
        // MODIFIED DATA STRUCTURE: 'equivalentGroup' added for substitution tracking.
        const medications = [
            {
                name: "ASA Protect Pharmavit (100mg)",
                boxes: 4,
                value: 30,
                daily: 1,
                startDate: "2025-11-05", 
                equivalentGroup: null,
                link: "https://www.hazipatika.com/gyogyszerkereso/termek/asa_protect_pharmavit_100_mg_gyomornedv_ellenallo_filmtabletta/56808" 
            },
            {
                name: "PANTOPRAZOL 1 A Pharma 20mg",
                boxes: 4,
                value: 28,
                daily: 1,
                startDate: "2025-11-05",
                equivalentGroup: null,
                link: "https://www.hazipatika.com/gyogyszerkereso/termek/pantoprazol_1_a_pharma_20_mg_gyomornedv_ellenallo_tabletta/51838" 
            },
            {
                name: "Rosuvastation Sandoz 20mg",
                boxes: 1,
                value: 30,
                daily: 1,
                startDate: "2025-11-05",
                equivalentGroup: "Rosuvastatin", // EQUIVALENT GROUP 1
                link: "https://www.hazipatika.com/gyogyszerkereso/termek/rosuvastatin_sandoz_20_mg_filmtabletta/54778"
            },
            {
                name: "Rozuva-Teva 20mg",
                boxes: 3,
                value: 30,
                daily: 1,
                startDate: "2025-12-06", 
                equivalentGroup: "Rosuvastatin", // EQUIVALENT GROUP 2
                link: "https://www.hazipatika.com/gyogyszerkereso/termek/rozuva_teva_20_mg_filmtabletta/59847"
            },
            {
                name: "Letrox 50mcg",
                boxes: 1,
                value: 100,
                daily: 1,
                startDate: "2025-11-05",
                equivalentGroup: null,
                link: "https://www.hazipatika.com/gyogyszerkereso/termek/letrox_50_g_tabletta/10483"
            },
            {
                name: "Coverex-AS 5mg",
                boxes: 8,
                value: 30,
                daily: 2,
                startDate: "2025-11-04",
                equivalentGroup: null,
                link: "https://www.hazipatika.com/gyogyszerkereso/termek/coverex_as_5_mg_filmtabletta/15650"
            },
            {
                name: "Meforal 1000mg",
                boxes: 4,
                value: 60,
                daily: 2,
                startDate: "2025-11-04",
                equivalentGroup: null,
                link: "https://www.hazipatika.com/gyogyszerkereso/termek/meforal_1000_mg_filmtabletta/14594"
            }
        ];
        
        // --- NEW LOGIC: PRE-CALCULATE AGGREGATED STOCK FOR EQUIVALENT GROUPS ---
        
        // 1. Group medications by their equivalentGroup (or their own name if no group)
        const groups = medications.reduce((acc, med) => {
            const key = med.equivalentGroup || med.name;
            if (!acc[key]) {
                acc[key] = { totalPills: 0, dailyDosage: med.daily, startDate: med.startDate, members: [] };
            }
            acc[key].totalPills += med.boxes * med.value;
            acc[key].members.push(med.name);
            return acc;
        }, {});

        // 2. Calculate the depletion date for each GROUP
        const calculatedGroups = {};
        for (const key in groups) {
            const group = groups[key];
            
            const daysSupply = Math.floor(group.totalPills / group.dailyDosage);

            const today = new Date();
            const startDate = new Date(group.startDate); 
            
            today.setHours(12, 0, 0, 0);
            startDate.setHours(12, 0, 0, 0);

            const diffTime = today.getTime() - startDate.getTime();
            const daysUsed = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            const actualDaysUsed = Math.max(0, daysUsed);

            const daysRemaining = daysSupply - actualDaysUsed;
            
            const depletionDate = new Date(today);
            depletionDate.setDate(today.getDate() + daysRemaining);

            calculatedGroups[key] = {
                depletionDate: depletionDate.toISOString().slice(0, 10),
                daysRemaining: Math.max(0, daysRemaining),
                memberCount: group.members.length
            };
        }
        
        // ------------------------------------------------------------------------

        // FUNCTION: Returns the calculated depletion data for the individual medication (now based on group)
        function getDepletionData(med) {
            const key = med.equivalentGroup || med.name;
            return calculatedGroups[key];
        }

        // Function to determine the status color class
        function getStatusClass(days) {
            if (days < 7) {
                return 'status-danger';
            } else if (days <= 30) {
                return 'status-warning';
            } else {
                return 'status-safe';
            }
        }
        
        // FUNCTION: Render the medication cards, incorporating sorting logic
        function renderMedications() {
            const listContainer = document.getElementById('medicationList');
            const sortCriteria = document.getElementById('sortSelector').value;
            
            // 1. Map medications to include the AGGREGATED daysRemaining and depletion date
            const medicationsWithDays = medications.map(med => {
                const calculatedData = getDepletionData(med);
                return {
                    ...med,
                    expiresOn: calculatedData.depletionDate,
                    daysRemaining: calculatedData.daysRemaining,
                    isEquivalent: med.equivalentGroup && calculatedData.memberCount > 1
                };
            });

            // 2. SORT the list based on the selected criteria
            medicationsWithDays.sort((a, b) => {
                if (sortCriteria === 'name_asc') {
                    return a.name.localeCompare(b.name);
                } else if (sortCriteria === 'days_asc') {
                    return a.daysRemaining - b.daysRemaining;
                } else if (sortCriteria === 'days_desc') {
                    return b.daysRemaining - a.daysRemaining;
                }
                return 0;
            });

            let htmlContent = '';

            medicationsWithDays.forEach(med => {
                const totalPills = med.boxes * med.value;
                const daysRemaining = med.daysRemaining; 
                const statusClass = getStatusClass(daysRemaining);
                
                const formattedStartDate = med.startDate.replace(/-/g, '.');
                
                const expiresDateFormatted = new Date(med.expiresOn).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                // NEW: Equivalence Info
                const equivalenceHtml = med.isEquivalent 
                    ? `<div class="equivalence-info">Part of <strong>${med.equivalentGroup}</strong> group. Supply based on combined stock.</div>`
                    : '';


                htmlContent += `
                    <div class="medication-card">
                        <h2>${med.name}</h2>
                        ${equivalenceHtml}
                        <div class="detail-row">
                            <span class="label">Packs:</span>
                            <span class="value">${med.boxes}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">Pills per Pack:</span>
                            <span class="value">${med.value}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">Total Pills (Pack):</span>
                            <span class="value">${totalPills}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">Daily Dosage:</span>
                            <span class="value">${med.daily} pill(s)</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">Start Date:</span>
                            <span class="value">${formattedStartDate}</span>
                        </div>
                        
                        <div class="expiration-info">
                            <div class="expiration-date">Stock Depletion: ${expiresDateFormatted}</div>
                            <div class="days-remaining ${statusClass}">${daysRemaining}</div>
                            <div class="label">Days Remaining (Group Stock)</div>
                        </div>
                        
                        <a href="${med.link}" class="details-button">
                            Details ðŸ”—
                        </a>
                    </div>
                `;
            });

            listContainer.innerHTML = htmlContent;
        }

        // Run the rendering function when the page loads
        document.addEventListener('DOMContentLoaded', () => {
             // Set the default sort
             document.getElementById('sortSelector').value = 'days_asc'; 
             renderMedications();
        });

    </script>
</body>
</html>