<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accu - Blood Glucose Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://npmcdn.com/chart.js@4.4.3/dist/chart.umd.js"></script>
    <script src="https://npmcdn.com/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.js"></script>
    <script src="https://npmcdn.com/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <script>
        // Tailwind dark mode configuration
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* Base styles for dark mode */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark gray background */
            color: #d1d5db; /* Light gray text */
        }
        .chart-container {
            position: relative;
            height: 60vh;
            width: 100%;
        }
        /* Custom scrollbar (optional, but looks good) */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        /* Styling the date picker icon in dark mode */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 md:p-8">
        
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">Accu Blood Glucose Analyzer</h1>
            <p class="text-lg text-gray-400">Blood glucose level data visualization from the uploaded .dia file.</p>
        </header>

        <div class="bg-gray-800 p-4 md:p-6 rounded-lg shadow-lg mb-8">
            <h3 class="text-xl font-semibold text-white mb-4">Select Period</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div class="col-span-1">
                    <label for="filter-start-date" class="block text-sm font-medium text-gray-300 mb-1">Start Date</label>
                    <input type="date" id="filter-start-date" class="w-full bg-gray-700 text-white p-2 rounded-lg border border-gray-600 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="col-span-1">
                    <label for="filter-end-date" class="block text-sm font-medium text-gray-300 mb-1">End Date</label>
                    <input type="date" id="filter-end-date" class="w-full bg-gray-700 text-white p-2 rounded-lg border border-gray-600 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="col-span-1">
                    <button id="filter-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        Filter
                    </button>
                </div>
                <div class="col-span-1">
                    <button id="reset-button" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        Reset
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h3 class="text-sm font-medium text-gray-400 uppercase">Number of Measurements</h3>
                <p id="stat-count" class="text-3xl font-bold text-white">-</p>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h3 class="text-sm font-medium text-gray-400 uppercase">Average Value</h3>
                <p id="stat-avg" class="text-3xl font-bold text-white">-</p>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h3 class="text-sm font-medium text-red-400 uppercase">Maximum Value</h3>
                <p id="stat-max" class="text-3xl font-bold text-red-300">-</p>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h3 class="text-sm font-medium text-blue-400 uppercase">Minimum Value</h3>
                <p id="stat-min" class="text-3xl font-bold text-blue-300">-</p>
            </div>
        </div>

        <main class="bg-gray-800 p-4 md:p-8 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold text-white mb-6">Blood Glucose Level (mmol/L) - Timeline</h2>
            <div id="loading-spinner" class="flex justify-center items-center h-64">
                <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-lg text-gray-300">Loading and processing data...</span>
            </div>
            
            <div id="error-message" class="hidden p-4 bg-red-900 text-red-200 rounded-lg">
                <h3 class="font-bold">Error Occurred</h3>
                <p id="error-text"></p>
            </div>

            <div class="chart-container">
                <canvas id="bgChart"></canvas>
            </div>
        </main>
        
        <footer class="text-center text-gray-500 mt-8">
            <p>Accu Project - Modern Web Application</p>
        </footer>
    </div>

    <script>
        // --- Medication Dose Change Definitions (NEW) ---
        const doseChanges = [
            // Dose 1: 2025.10.25-2025.11.03 (Light Orange)
            { startDate: '2025-10-25', endDate: '2025-11-03', label: 'Dose Change 1', color: 'rgba(255, 165, 0, 0.15)' },
            // Dose 2: 2025.11.04-2025.12.07 (Light Blue)
            { startDate: '2025-11-04', endDate: '2025-12-07', label: 'Dose Change 2', color: 'rgba(54, 162, 235, 0.15)' },
            // Dose 3: 2025.12.08-today (Light Purple - using a distant future date)
            { startDate: '2025-12-08', endDate: '2050-12-31', label: 'Dose Change 3', color: 'rgba(153, 102, 255, 0.15)' }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            const fileName = "{b41a95fe-1686-419e-b04b-2b0a87b145d4}.dia";
            const loadingSpinner = document.getElementById('loading-spinner');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const filterStartDateInput = document.getElementById('filter-start-date');
            const filterEndDateInput = document.getElementById('filter-end-date');
            const filterButton = document.getElementById('filter-button');
            const resetButton = document.getElementById('reset-button');

            let bgChartInstance = null; // To store the chart instance
            let allChartData = []; // To store all read data
            let targetRangeFrom = 3.9;
            let targetRangeTo = 8.9;
            let hypoLimit = 3.9;
            let minTimestamp = null; // Stores the min date of actual data
            let maxTimestamp = null; // Stores the max date of actual data

            // FIX: Robustly format date to YYYY-MM-DD string using local time components
            function formatDateToInput(date) {
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            async function loadAndProcessData() {
                try {
                    // 1. Load data
                    const response = await fetch(fileName);
                    if (!response.ok) {
                        throw new Error(`Network error: ${response.status} ${response.statusText}. File not found: ${fileName}`);
                    }
                    const xmlText = await response.text();

                    // 2. Process XML
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, "application/xml");
                    
                    if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                        throw new Error("XML file processing failed. It might be corrupted.");
                    }

                    const bgNodes = xmlDoc.getElementsByTagName("BG");
                    const settingsNode = xmlDoc.getElementsByTagName("status")[0];

                    const data = [];
                    let minDate = new Date('9999-12-31T00:00:00');
                    let maxDate = new Date('1000-01-01T00:00:00');

                    // Read and store target values
                    targetRangeFrom = parseFloat(settingsNode.getAttribute("TgRngFrom") || 3.9);
                    targetRangeTo = parseFloat(settingsNode.getAttribute("TgRngTo") || 8.9);
                    hypoLimit = parseFloat(settingsNode.getAttribute("HypoLmt") || 3.9);

                    // 3. Data extraction
                    for (let node of bgNodes) {
                        const date = node.getAttribute("Dt");
                        const time = node.getAttribute("Tm");
                        const glucose = parseFloat(node.getAttribute("Gl"));

                        if (date && time && !isNaN(glucose)) {
                            // FIX: Using T00:00:00 helps JavaScript recognize it as local time, preventing UTC shifts
                            const timestamp = new Date(`${date}T${time}:00`); 
                            data.push({ x: timestamp, y: glucose });

                            // Find Min/Max date
                            if (timestamp.getTime() < minDate.getTime()) minDate = timestamp;
                            if (timestamp.getTime() > maxDate.getTime()) maxDate = timestamp;
                        }
                    }

                    if (data.length === 0) {
                        throw new Error("No valid blood glucose (BG) data found in the file.");
                    }

                    // Sort data by time
                    data.sort((a, b) => a.x - b.x);
                    
                    allChartData = data; // Save all data
                    minTimestamp = data[0].x; // Set actual min timestamp
                    maxTimestamp = data[data.length - 1].x; // Set actual max timestamp


                    // 4. Set date pickers to min/max date using the robust function
                    filterStartDateInput.value = formatDateToInput(minTimestamp);
                    filterEndDateInput.value = formatDateToInput(maxTimestamp);

                    // 5. Update dashboard with the full dataset
                    updateDashboard(allChartData);

                    // 6. Add event handlers to buttons
                    filterButton.addEventListener('click', handleFilter);
                    resetButton.addEventListener('click', handleReset);

                } catch (error) {
                    console.error("Error during data processing:", error);
                    errorText.textContent = error.message;
                    errorMessage.classList.remove('hidden');
                } finally {
                    loadingSpinner.classList.add('hidden');
                }
            }

            // New function to update statistics and chart
            function updateDashboard(data) {
                let sum = 0;
                let min = Infinity;
                let max = -Infinity;

                if (data.length === 0) {
                    min = 0;
                    max = 0;
                } else {
                    for (const item of data) {
                        sum += item.y;
                        if (item.y < min) min = item.y;
                        if (item.y > max) max = item.y;
                    }
                }

                // Display statistics
                document.getElementById('stat-count').textContent = data.length;
                document.getElementById('stat-avg').textContent = data.length > 0 ? (sum / data.length).toFixed(1) : '-';
                document.getElementById('stat-max').textContent = data.length > 0 ? max.toFixed(1) : '-';
                document.getElementById('stat-min').textContent = data.length > 0 ? min.toFixed(1) : '-';

                // Determine the visible range for the chart's X-axis
                let chartMinX = data.length > 0 ? data[0].x : null;
                let chartMaxX = data.length > 0 ? data[data.length - 1].x : null;

                renderChart(data, targetRangeFrom, targetRangeTo, hypoLimit, chartMinX, chartMaxX);
            }

            // Filter event handler
            function handleFilter() {
                // T00:00:00 and T23:59:59 ensures the full day is included
                const startDate = new Date(`${filterStartDateInput.value}T00:00:00`);
                const endDate = new Date(`${filterEndDateInput.value}T23:59:59`);
                
                if (startDate > endDate) {
                    alert("Start date cannot be later than the end date.");
                    return;
                }

                const filteredData = allChartData.filter(item => {
                    return item.x >= startDate && item.x <= endDate;
                });

                updateDashboard(filteredData);
            }

            // Reset event handler
            function handleReset() {
                // Reset to full data range
                updateDashboard(allChartData);
                
                // Reset the date pickers
                if (allChartData.length > 0) {
                    filterStartDateInput.value = formatDateToInput(minTimestamp);
                    filterEndDateInput.value = formatDateToInput(maxTimestamp);
                }
            }

            // Updated renderChart function with X-axis range and Y-axis fix
            function renderChart(data, targetFrom, targetTo, hypo, chartMinX, chartMaxX) {
                const ctx = document.getElementById('bgChart').getContext('2d');
                
                if (bgChartInstance) {
                    bgChartInstance.destroy(); // Destroy previous chart if exists
                }

                // -------------------------------------------------------------
                // 1. Generate Dose Change Annotations 
                // -------------------------------------------------------------
                const doseAnnotations = {};
                doseChanges.forEach((change, index) => {
                    const key = `doseChange_${index}`; 
                    
                    doseAnnotations[key] = {
                        type: 'box',
                        xMin: change.startDate,
                        xMax: change.endDate, 
                        // FIX: Changed yMax to a high value to cover the entire chart height
                        yMin: 0,
                        yMax: 100, // Guaranteed to be higher than any typical BG reading
                        backgroundColor: change.color,
                        borderColor: 'transparent',
                        borderWidth: 0,
                        label: {
                            content: change.label,
                            display: true,
                            position: 'start',
                            color: '#9ca3af', // Light gray text
                            backgroundColor: 'rgba(17, 24, 39, 0.6)', // Dark background for readability
                            font: {
                                size: 10
                            }
                        }
                    };
                });
                // -------------------------------------------------------------

                // 2. Combine all annotations (Dose Changes + Target Range + Hypo Line)
                const allAnnotations = {
                    ...doseAnnotations, 
                    
                    // Existing Target Range Annotation
                    targetRange: {
                        type: 'box',
                        yMin: targetFrom,
                        yMax: targetTo,
                        backgroundColor: 'rgba(74, 222, 128, 0.1)', 
                        borderColor: 'rgba(74, 222, 128, 0.3)',
                        borderWidth: 1,
                        label: {
                            content: 'Target Range',
                            display: true,
                            position: 'start',
                            color: 'rgba(74, 222, 128, 0.7)',
                            font: {
                                size: 10
                            }
                        },
                        z: 1 
                    },
                    
                    // Existing Hypo Line Annotation
                    hypoLine: {
                        type: 'line',
                        yMin: hypo,
                        yMax: hypo,
                        borderColor: 'rgb(249, 115, 22)', 
                        borderWidth: 2,
                        borderDash: [6, 6], 
                        label: {
                            content: `Hypo (${hypo.toFixed(1)})`,
                            display: true,
                            position: 'start',
                            color: 'rgb(249, 115, 22)',
                            backgroundColor: 'rgba(17, 24, 39, 0.6)',
                            font: {
                                size: 10,
                                weight: 'bold'
                            }
                        },
                        z: 1 
                    }
                };

                // 3. Create the Chart
                bgChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Blood Glucose (mmol/L)',
                            data: data,
                            borderColor: 'rgb(59, 130, 246)', 
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            pointBackgroundColor: (context) => {
                                const value = context.raw.y;
                                if (value > targetTo) return 'rgb(239, 68, 68)'; 
                                if (value < hypo) return 'rgb(249, 115, 22)'; 
                                return 'rgb(59, 130, 246)'; 
                            },
                            pointRadius: 3,
                            pointHoverRadius: 6,
                            fill: true, 
                            tension: 0.1 
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                // FIX: Force the X-axis scale to match the visible data range
                                min: chartMinX, 
                                max: chartMaxX,
                                time: {
                                    unit: 'day',
                                    tooltipFormat: 'yyyy. MM. dd. HH:mm',
                                    displayFormats: {
                                        day: 'MM. dd.'
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Date and Time',
                                    color: '#d1d5db'
                                },
                                ticks: {
                                    color: '#9ca3af',
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Blood Glucose (mmol/L)',
                                    color: '#d1d5db'
                                },
                                ticks: {
                                    color: '#9ca3af',
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false 
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: '#1f2937',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                            },
                            annotation: {
                                annotations: allAnnotations 
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                });
            }

            // Load data when the page loads
            loadAndProcessData();
        });
    </script>
</body>
</html>